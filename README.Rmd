---
title: "DIDdesign"
output:
  md_document:
    variant: gfm
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  cache = TRUE,
  warning = FALSE,
  message = FALSE
)
```

# DIDdesign: Double Difference-in-Differences


<!-- badges: start -->
[![R build status](https://github.com/naoki-egami/DIDdesign/workflows/R-CMD-check/badge.svg)](https://github.com/naoki-egami/DIDdesign/actions)
<!-- badges: end -->

Authors:

- [Naoki Egami](https://naokiegami.com/)
- [Soichiro Yamauchi](https://soichiroy.github.io/)


Reference:

- Egami and Yamauchi (2019) "Using Multiple Pre-treatment Periods to Improve Difference-in-Differences and Staggered Adoption Designs."

## Installation Instructions:

- Downloading the most recent version of `DIDdesign` from Github

	```r
	## need to install `devtools` if necessary
	require(devtools)
	install_github("naoki-egami/DIDdesign", dependencies = TRUE)
	```

## The Standard Difference-in-Differences Design




### Panel Data


```{r, message=FALSE,warning=FALSE}
## load package
require(DIDdesign)

## load data
data(anzia2012)
```




```{r panel}
## estimate treatment effect
set.seed(1234)
fit_panel <- did(
  formula  = lnavgsalary_cpi ~ oncycle | teachers_avg_yrs_exper +
                                          ami_pc + asian_pc + black_pc + hisp_pc,
  data     = anzia2012,
  id_unit  = "district",
  id_time  = "year",
  design   = "did",
  is_panel = TRUE,
  option   = list(n_boot = 200, parallel = TRUE, lead = 0:2)
)
```


`did()` function takes the following arguments:

- `formula`: A formula specifying variables. It should follow the form of `outcome ~ treatment | covariates`.
   - `treatment` should be time-varying, that is, `treatment` takes zero for everyone before the treatment assignment, and takes 1 for units who are treated. See the example for how the treatment variable should be coded.
   - `covariates` can be omitted as `outcome ~ treatment`.
- `data`: A data frame. This can be either `data.frame` or `tibble`.
- `id_unit`: A variable name in the data that uniquely identifies units (e.g., individuals or states).
- `id_time`: A variable name in the data that uniquely identifies time (e.g., year).
- `design`: Design option. It should be `"did"` when the standard DID design is used.
- `is_panel`: A boolean argument to indicate the type of the data. When the dataset is panel (i.e., same observations are measured repeately overtime), it should take `TRUE`. See the next section for how to analyze the repeated cross-section data.
- `option`: A list of options.
   - `n_boot`: Number of bootstrap iterations to estimate weighting matrix.
   - `parallel`: A boolean argument. If `TRUE`, bootstrap is conducted in parallel using `future` package.
   - `lead`: A vector of non-negative lead parameter. For example, when `lead = c(0, 1)`, treatment effect when the treatment is assigned (`lead = 0`) as well as one-time ahead effect (`lead = 1`) will be estimated. Default is `lead = 0`.



```{r}
## view the estimates
summary(fit_panel)
```


`summary()` function can be used to view estimates.




### Repeated Cross-sectional Data

Sometimes, each period consists of different units, instead of repeated observations of the same units.
`did()` can handle such "repeated cross-sectional" data by setting `is_panel = FALSE`.
As an example, we analyze `malesky2014` dataset (see `?malesky2014` for more details on this dataset).

```{r, rcs, eval=TRUE}
## load data
data(malesky2014)

## estimate ATT
set.seed(1234)
ff_rcs <- did(
  formula = transport ~ treatment + post_treat | factor(city),
  data    = malesky2014,
  id_time = 'year',
  is_panel= FALSE,
  option  = list(n_boot = 200, parallel = TRUE, id_cluster = "tinh", lead = 0)
)
```


- `formula` now includes `treatment` variable as well as the post-treatment time indicator.
- `id_cluster`: A variable used to cluster the standard errors.


```{r rcs_summary}
summary(ff_rcs)
```


## Staggered Adoption Design

`DIDdesign` supports the staggered adoption design where units receive the treatment at different periods of time.
As an example, we analyze `paglayan2019` dataset in the package (see `?paglayan2019` for more details about this dataset).

```{r sa_data, warning=FALSE, message=FALSE}
## data
require(dplyr)
require(tibble)

## format dataset
paglayan2019 <- paglayan2019 %>%
  filter(!(state %in% c("WI", "DC"))) %>%
  mutate(id_time = year,
         id_subject = as.numeric(as.factor(state)),
         log_expenditure = log(pupil_expenditure + 1),
         log_salary      = log(teacher_salary + 1))
```

```{r sa_plot, echo=FALSE, dpi=250, warning=FALSE, message=FALSE}
require(tidyr)
require(stringr)

treatment_variation <- paglayan2019 %>%
  select(state, year, treatment) %>%
  group_by(state) %>%
  mutate(treatment_sum = sum(treatment)) %>%
  arrange(desc(treatment_sum), state, year) %>%
  select(-treatment_sum) %>%
  pivot_wider(id_cols = "state", names_prefix = "year",
              names_from = year, values_from = treatment) %>%
  ungroup() %>%  column_to_rownames(var = "state") %>%
  data.matrix()


## plot
par(mar = c(2, 2, 0.5, 0.5))
image(t(apply(treatment_variation, 2, rev)), col = c("lightgray", '#1E88A8'),
      xaxt = "n", yaxt = "n")
axis(1, at = seq(0, 1, length.out = ncol(treatment_variation)),
        labels = str_remove(colnames(treatment_variation), "year"),
        las = 2, cex.axis = 0.8, tick = FALSE, mgp = c(0, 0, 0.2))
axis(2, at = seq(0, 1, length.out = nrow(treatment_variation)),
        labels = rownames(treatment_variation),
        las = 2, cex.axis = 0.65, tick = FALSE, mgp = c(0, 0, 0.2))
diff_h <- min(diff(seq(0, 1, length.out = nrow(treatment_variation))))
diff_v <- min(diff(seq(0, 1, length.out = ncol(treatment_variation))))
abline(h = seq(0, 1, length.out = nrow(treatment_variation)) + diff_h/2, lty = 1, col = 'white', lwd = 0.3)
abline(v = seq(0, 1, length.out = ncol(treatment_variation)) + diff_v/ 2, lty = 1, col = 'white', lwd = 0.3)
legend("topright", legend = c("Treated", "Control"), fill = c('#1E88A8', 'lightgray'), bg = 'white', cex = 0.8)
box(lwd = 1.1)
```

As we can see in the above plot, states receive the treatment at different years ranging from 1965 at earliest to 1987 at latest (and some of the states never receive the treatment).

`did()` function can handle the staggered adoption design by setting the `design` argument to `design = "SA"`.

```{r sa_estimation}
## estimate time-weighted SA-ATE
set.seed(1234)
fit_sa <- did(
  formula = log_expenditure ~ treatment,
  data    = paglayan2019,
  id_unit = "id_subject",
  id_time = "id_time",
  design  = "sa",
  option  = list(n_boot = 200, lead = 0:9, thres = 2, parallel = TRUE)
)
```

In addition to options described in the previous section, there is one additional argument specific to the staggered adoption design.

- `thres` parameter in the option control the minimum number of treated units for a particular time to be included in the treatment effect estimation. For example if `thres = 2`, the effect for Tennessee will be removed from the time-average effect because it's the only unit who received the treatment in 1972 (i.e., the number of treated units in 1972 is less than the threshold).


```{r sa_summary}
head(summary(fit_sa))
```


```{r echo=FALSE, out.width="100%", dpi=250}
## plot data   
plot_dat <- as_tibble(summary(fit_sa)) %>%
  filter(estimator == "SA-Double-DID") %>%
  mutate(CI90_UB = estimate + qnorm(0.95) * std.error,
         CI90_LB = estimate - qnorm(0.95) * std.error)

## plot
par(mar = c(3.8, 4, 3, 1), pty = 's')
plot(plot_dat$lead, plot_dat$estimate, type = 'o', pch = 16,
     xlab = "Time", ylab = "SA-ATT", main = "Double DID Estimates",
     xaxt = "n", ylim = c(-0.1, 0.1), las = 1
   )
abline(h = 0, col = 'gray', lty = 3, lwd = 1.5)
axis(1, at = plot_dat$lead, labels = paste0("t = ", plot_dat$lead), cex.axis = 0.9)
polygon(
  c(plot_dat$lead, rev(plot_dat$lead)),
  c(plot_dat$CI90_UB, rev(plot_dat$CI90_LB)),
  border = NA, col = rgb(128,128,128, maxColorValue = 255, alpha = 50)
)
```
